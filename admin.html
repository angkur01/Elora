<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Birthday Admin üëë</title>

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">

<style>
*{margin:0;padding:0;box-sizing:border-box;}

body{
font-family:'Poppins',sans-serif;
background:linear-gradient(135deg,#111,#2b2b2b);
color:white;
min-height:100vh;
display:flex;
justify-content:center;
align-items:center;
padding:30px;
}

.panel{
width:100%;
max-width:900px;
background:rgba(255,255,255,0.05);
backdrop-filter:blur(20px);
border-radius:20px;
padding:35px;
box-shadow:0 20px 60px rgba(0,0,0,0.6);
}

h1{text-align:center;margin-bottom:25px;}

label{
display:block;
margin-top:15px;
font-weight:600;
}

input, textarea{
width:100%;
margin-top:6px;
padding:10px;
border-radius:10px;
border:none;
background:#1a1a1a;
color:white;
font-size:14px;
}

textarea{min-height:100px;}

button{
margin-top:20px;
padding:12px 25px;
border:none;
border-radius:30px;
background:linear-gradient(45deg,#ff4fa3,#ff9ecb);
color:white;
font-weight:600;
cursor:pointer;
}

.logout-btn{
background:#444;
margin-left:10px;
}

.preview{
margin-top:15px;
display:flex;
flex-wrap:wrap;
gap:10px;
}

.image-box{
position:relative;
}

.preview img{
width:100px;
border-radius:10px;
}

.delete-btn{
background:red;
border:none;
color:white;
border-radius:50%;
width:22px;
height:22px;
cursor:pointer;
position:absolute;
top:-5px;
right:-5px;
}
</style>
</head>

<body>

<div class="panel">

<h1>Birthday Admin üëë</h1>

<label>Hero Title</label>
<input id="heroTitle">

<label>Name</label>
<input id="name">

<label>Nickname</label>
<input id="nickname">

<label>Birthday</label>
<input type="date" id="birthday">

<label>Surprise Button Text</label>
<input id="surpriseButton">

<label>Cake Button Text</label>
<input id="cakeButton">

<label>Surprise Title</label>
<input id="surpriseTitle">

<label>Surprise Message</label>
<textarea id="surpriseMessage"></textarea>

<label>Cake Name</label>
<input id="cakeName">

<label>Upload Photos (Surprise Page)</label>
<input type="file" id="fileInput" multiple accept="image/*">

<div class="preview" id="preview"></div>

<button onclick="saveData()">Save Changes</button>
<button class="logout-btn" onclick="logout()">Logout</button>

</div>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { 
  getAuth, 
  signInWithEmailAndPassword, 
  onAuthStateChanged,
  signOut 
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

import { 
  getFirestore, 
  doc, 
  setDoc, 
  getDoc 
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyAqjJdmgZoxn4b_SYcq4jCupkgOw2B6WAc",
  authDomain: "elora-birthday.firebaseapp.com",
  projectId: "elora-birthday",
  storageBucket: "elora-birthday.firebasestorage.app",
  messagingSenderId: "34536952055",
  appId: "1:34536952055:web:388846fa6e28026a2a43f2"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

let currentUser = null;
let images = [];

/* üîê LOGIN OVERLAY */
document.body.insertAdjacentHTML("afterbegin", `
<div id="loginBox" style="
position:fixed;
inset:0;
background:#111;
display:flex;
justify-content:center;
align-items:center;
z-index:9999;">
<div style="background:#222;padding:30px;border-radius:15px;width:300px;">
<h3 style="margin-bottom:15px;text-align:center;">Admin Login üîê</h3>
<input id="email" placeholder="Email" style="width:100%;padding:8px;margin-bottom:10px;">
<input id="password" type="password" placeholder="Password" style="width:100%;padding:8px;margin-bottom:15px;">
<button id="loginBtn" style="width:100%;padding:10px;background:#ff4fa3;border:none;border-radius:10px;color:white;">Login</button>
</div>
</div>
`);

const loginBox = document.getElementById("loginBox");

document.getElementById("loginBtn").onclick = async () => {
  const email = document.getElementById("email").value;
  const password = document.getElementById("password").value;

  try{
    await signInWithEmailAndPassword(auth, email, password);
  }catch(e){
    alert("Login failed ‚ùå");
  }
};

onAuthStateChanged(auth, user => {
  if(user){
    currentUser = user;
    loginBox.style.display = "none";
    loadData();
  } else {
    currentUser = null;
  }
});

/* ‚òÅ Cloudinary */
const CLOUD_NAME = "drbf0bgpw";
const UPLOAD_PRESET = "birthday_unsigned";

async function uploadImage(file){
  document.body.style.cursor="wait";

  const formData = new FormData();
  formData.append("file", file);
  formData.append("upload_preset", UPLOAD_PRESET);

  const res = await fetch(
    `https://api.cloudinary.com/v1_1/${CLOUD_NAME}/image/upload`,
    { method:"POST", body:formData }
  );

  const data = await res.json();
  document.body.style.cursor="default";

  return data.secure_url;
}

document.getElementById("fileInput").addEventListener("change", async e=>{
  const files = e.target.files;
  for(let file of files){
    const url = await uploadImage(file);
    images.push(url);
    renderImages();
  }
});

function renderImages(){
  const preview = document.getElementById("preview");
  preview.innerHTML="";

  images.forEach((img,index)=>{
    const box=document.createElement("div");
    box.className="image-box";

    const image=document.createElement("img");
    image.src=img;

    const del=document.createElement("button");
    del.className="delete-btn";
    del.innerText="√ó";
    del.onclick=()=>deleteImage(index);

    box.appendChild(image);
    box.appendChild(del);
    preview.appendChild(box);
  });
}

function deleteImage(index){
  images.splice(index,1);
  renderImages();
}

/* üíæ SAVE DATA */
window.saveData = async function(){
  if(!currentUser){
    alert("Not authorized ‚ùå");
    return;
  }

  const siteData={
    heroTitle:heroTitle.value,
    name:name.value,
    nickname:nickname.value,
    birthday:birthday.value,
    surpriseButton:surpriseButton.value,
    cakeButton:cakeButton.value,
    surpriseTitle:surpriseTitle.value,
    surpriseMessage:surpriseMessage.value,
    cakeName:cakeName.value,
    musicVolume:0.4,
    images:images
  };

  await setDoc(doc(db,"birthday","main"),siteData);
  alert("Saved Securely üëë");
}

/* üì• LOAD DATA */
async function loadData(){
  const snap=await getDoc(doc(db,"birthday","main"));
  if(snap.exists()){
    const data=snap.data();

    Object.keys(data).forEach(key=>{
      if(document.getElementById(key)){
        document.getElementById(key).value=data[key];
      }
    });

    images=data.images||[];
    renderImages();
  }
}

/* üö™ LOGOUT */
window.logout = async function(){
  await signOut(auth);
  location.reload();
}

</script>

</body>
</html>